제공해주신 코드는 **서울시의 공공 데이터와 상업 데이터를 활용하여 특정 위치의 '슬세권(슬리퍼를 신고 갈 수 있는 편리한 권역) 지수'를 분석하고 시각화해주는 대시보드 애플리케이션**입니다.

이 코드가 어떻게 작동하는지 핵심 로직을 먼저 설명드리고, 이어서 코드의 각 부분을 상세히 설명하겠습니다.

---

### 1. 전체 작동 원리 (Workflow)

1.  **데이터 로드 및 정제**: 서울시 내의 스타벅스, 버스정류장, 지하철역, 병원, 공원 등 다양한 시설 데이터를 읽어와서 위경도 좌표를 통일하고 중복된 데이터를 제거합니다.
2.  **위치 검색 (Geocoding)**: 사용자가 주소나 건물명을 입력하면 카카오 API를 통해 해당 위치의 위도와 경도 좌표를 가져옵니다.
3.  **거리 계산 및 필터링**: 설정된 반경(예: 500m) 내에 어떤 시설들이 있는지 `geopy` 라이브러리를 사용해 실시간으로 거리를 계산합니다.
4.  **지수 산출 (Scoring)**: 7가지 카테고리(생활, 교통, 의료 등)별로 시설 개수를 파악하고, 사용자가 설정한 가중치를 적용하여 100점 만점의 '슬세권 지수'를 계산합니다.
5.  **시각화**: 결과를 지도(Folium), 게이지 차트, 방사형 차트(Radar), 바 차트 등으로 보여주며, 분석 결과를 HTML 보고서로 다운로드할 수 있게 합니다.

---

### 2. 코드 상세 설명 (행별 해설)

코드가 길기 때문에 주요 기능 블록 단위로 나누어 설명하겠습니다.

#### [1단계: 라이브러리 임포트 및 환경 설정]
```python
import streamlit as st           # 웹 대시보드 프레임워크
import pandas as pd              # 데이터 분석 및 처리
import folium                    # 지도 시각화
import plotly.express as px      # 차트 시각화 (도넛, 바 차트)
import plotly.graph_objects as go # 차트 시각화 (레이더, 게이지 차트)
from geopy.distance import geodesic # 좌표 간 거리 계산
import os                        # 파일 경로 및 환경 변수 관리
import requests                  # API 요청 (카카오 주소 검색용)
from dotenv import load_dotenv   # .env 파일에서 API 키 로드
from streamlit_folium import st_folium # 스트림릿에 폴리움 지도 표시
import re                        # 정규표현식 (동 이름 추출)
```

#### [2단계: 상수 및 스타일 정의]
*   `EMOJI_MAP`: 시설 종류에 맞는 이콘(Emoji) 매핑
*   `CATEGORY_GROUPS`: 여러 데이터를 7개의 대분류로 그룹화
*   `DEFAULT_WEIGHTS`: 지수 계산 시 사용할 기본 가중치 (총합 100)
*   `st.markdown("""<style>...""")`: 대시보드의 디자인(폰트, 카드 스타일, 점수 색상 등)을 CSS로 정의합니다.

#### [3단계: 핵심 함수 - 주소 변환 및 데이터 로드]
*   **`get_coords_from_address(address)`**:
    *   카카오 API를 사용해 입력된 문자열 주소를 위도/경도로 변환합니다.
*   **`load_all_data()`**:
    *   `data/cleaned` 폴더 안의 모든 CSV 파일을 읽어옵니다.
    *   **좌표 자동 교정**: 위도와 경도가 거꾸로 저장된 경우(서울 범위 밖)를 찾아 자동으로 위치를 바꿉니다.
    *   **중복 제거**: 이름이 같고 좌표가 매우 가까운(소수점 4자리까지 동일) 시설은 하나로 합칩니다.

#### [4단계: 핵심 함수 - 슬세권 지수 계산 (`calculate_seulsekwon_index`)]
*   **반경 필터링**: 사용자가 설정한 반경 내에 있는 데이터만 추출합니다.
*   **점수 계산 로직**:
    *   각 카테고리별로 `최대 기대치(max_counts)`를 설정합니다 (예: 편의점은 15개 이상이면 만점).
    *   `실제 개수 / 기대치` 비율에 `사용자 가중치`를 곱해 카테고리 점수를 냅니다.
    *   모든 점수를 합산하여 최종 0~100점 사이의 점수를 산출합니다.

#### [5단계: 시각화 및 보고서 생성]
*   **`create_visualizations(...)`**:
    *   `Radar Chart`: 어떤 분야의 인프라가 강점인지 보여줍니다.
    *   `Gauge Chart`: 종합 점수를 속도계 모양으로 보여줍니다.
    *   `Compare Bar`: 검색한 지역의 인프라 구성 비율을 서울시 전체 평균과 비교합니다.
*   **`create_enhanced_map(...)`**:
    *   지도의 중심에 분석 지점을 표시하고, 반경 내 모든 시설물을 이모지 아이콘으로 지도 위에 뿌려줍니다.
*   **`export_to_html(...)`**:
    *   현재 분석 결과와 차트들을 그대로 담은 독립된 HTML 보고서 파일을 생성하는 템플릿 코드입니다.

#### [6단계: Streamlit 메인 UI 코드]
```python
# 데이터 로드 (세션 상태를 사용해 한 번만 로드)
if 'data' not in st.session_state:
    st.session_state.data = load_all_data()

# 검색 폼 (주소 입력 및 반경 선택)
with st.form("main_search"):
    # 입력 UI 구성...

# 사이드바 가중치 조정
with st.sidebar:
    # 사용자가 실시간으로 가중치를 5단위로 조정 가능
    # 합계가 100이 아니면 경고 메시지 출력

# 메인 화면 레이아웃
col_map, col_res = st.columns([1.8, 1])
with col_map:
    # 지도 표시 (클릭한 위치로 재분석 기능 포함)
with col_res:
    # 종합 점수 및 등급(S, A, B, C) 표시

# 하단 상세 차트 레이아웃
# 레이더, 비교 바, 도넛 차트를 3열로 배치
```

---

### 3. 이 코드의 특징 및 장점

1.  **데이터 정제 기술**: 위경도 오류 자동 교정과 중복 데이터 처리 로직이 들어있어 분석 결과의 신뢰도가 높습니다.
2.  **사용자 맞춤형**: 사람마다 중요하게 생각하는 인프라(누구는 교통, 누구는 공원)가 다르므로 가중치를 직접 조절하게 하여 개인화된 점수를 제공합니다.
3.  **인터랙티브 지도**: 지도를 단순히 보는 것에 그치지 않고, 지도의 특정 지점을 클릭하면 그 지점을 기준으로 즉시 재분석이 실행됩니다.
4.  **보고서 기능**: 분석 내용을 파일로 소장할 수 있도록 HTML 내보내기 기능을 지원합니다.

이 코드는 부동산 분석, 상권 분석 또는 이사 갈 동네를 비교할 때 매우 유용하게 사용될 수 있는 완성도 높은 대시보드 시스템입니다.